# 最適なパーセンタイルを選定するための機械学習アプローチ

## 1. 問題定義

まず、目指すべき目標を明確に定義します。今回のケースでは、「動きの強さを測るための最適なパーセンタイルを選定する」ことが目標です。

### 目標
- **動きの強さ**（例えば、光学フローのマグニチュード）の推定
- その推定がどれほど正確で、外れ値を除去しているか
- 動きの特徴がどれだけ適切に捉えられているか（例えば、急激な動きが適切に捉えられ、ノイズや誤検出が抑制されているか）

## 2. 特徴量の選定

次に、機械学習のための特徴量（特徴量エンジニアリング）を決定します。特徴量としては、以下のようなものが考えられます：

- **パーセンタイルの値**（異なるパーセンタイル、例：70%、75%、80%、85%、90%）
- **動きの強さの分布**：各フレームにおける動きの強さ（マグニチュード）のヒストグラム
- **動きの方向性**：動きがどの方向に偏っているか（X、Y成分）
- **動きの集中度**：動きの強さがどれだけ局所的に集中しているか（例えば、ROI内での分布）
- **時間的変化**：フレーム間での動きの変化（急激な変動が多いか）

## 3. 機械学習アルゴリズムの選択

### (1) 回帰モデル（回帰タスク）
パーセンタイルを予測するために回帰問題としてモデルを設定できます。ここでは、パーセンタイルを「ターゲット変数」として、特徴量を使ってモデルを学習させます。回帰モデルは数値を予測するタスクに適しています。

- **線形回帰**：最も単純な方法ですが、特徴量とターゲットの関係が線形でない場合、パフォーマンスが低下する可能性があります。
- **ランダムフォレスト回帰**：特徴量の非線形性を捉え、外れ値にも強い、より柔軟な回帰手法です。
- **勾配ブースティング**（XGBoost、LightGBMなど）：決定木を基盤にした強力な手法で、特徴量の選択や重要度を評価するのにも有効です。
- **ニューラルネットワーク（NN）**：深層学習モデルを使うことで、複雑な関係性を捉えることができますが、計算リソースが必要です。

### (2) 分類モデル（分類タスク）
パーセンタイルを「クラスラベル」として設定し、最適なパーセンタイルを選択するための分類タスクにする方法です。

- **ロジスティック回帰**：シンプルで高速な分類モデルですが、クラス間の関係が線形であることが前提です。
- **ランダムフォレスト分類**：多数の決定木を使用したアンサンブル学習モデルで、分類精度が高く、特徴量の選択に強いです。
- **サポートベクターマシン（SVM）**：複雑な境界を学習することができ、非線形問題にも対応可能です。
- **ニューラルネットワーク（NN）**：多クラス分類問題として、複雑なパターンを学習することができます。

### (3) 強化学習（実験的な最適化）
最適なパーセンタイルを見つけるために強化学習を使うアプローチもあります。強化学習では、「エージェント」があるアクション（例えば、異なるパーセンタイルを適用）を選び、その結果に基づいて報酬を得ます。エージェントは、最適なパーセンタイルを学習するために繰り返し試行を行います。

- **Q学習**や**深層Qネットワーク（DQN）**を使って、最適なパーセンタイルを学習します。

## 4. データセットの作成

機械学習を使うためには、適切なデータセットを準備する必要があります。以下のようなデータを収集します：

- **特徴量**: フレームごとの動きの強さ（光学フロー）、ヒストグラム、動きの方向性など。
- **ターゲット**: 目標となるパーセンタイル（例えば、85%タイルをターゲットとして学習）。

例えば、10秒間の動画から得られる特徴量を100フレーム分集めて、それを元にモデルを学習させます。

## 5. モデルの評価と選定

モデルを訓練した後、その精度を評価します。評価指標としては、以下のものが考えられます：

- **平均絶対誤差（MAE）**：予測されたパーセンタイルと実際のパーセンタイルの差の絶対値の平均。
- **平均二乗誤差（MSE）**：誤差を二乗して平均を取ったもの。外れ値に敏感です。
- **R2スコア**：回帰問題のモデルの性能を評価する指標で、0から1の範囲で評価します。

## 6. モデルチューニングと最適化

- **ハイパーパラメータチューニング**（Grid Search、Random Search）を使って、最適なモデルとそのパラメータを見つけます。
- **クロスバリデーション**を行い、モデルの汎化性能（他のデータセットに対する適用可能性）を評価します。

## 7. 最終的な選定

最終的に最もパフォーマンスが良いとされるパーセンタイルを選定し、それを動きの強さを計算する際の基準として使用します。

---

## 結論

最適なパーセンタイルを選定するために使用する機械学習アルゴリズムとしては、**回帰モデル（ランダムフォレスト回帰、勾配ブースティングなど）**が特に有力です。また、複数のパーセンタイルを評価し、モデルが最適なものを学習できるようにするための特徴量エンジニアリングが鍵となります。

さらに、強化学習を使った最適化アプローチも実験的には興味深いですが、通常は回帰問題としてモデルを構築する方が簡便で効果的だと思われます。



# 条件分岐
輝度値が一定を下回ればエラーとする。
